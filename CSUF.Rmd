---
title: "CSUF"
author: "Haley Bjursten"
date: "5/13/2020"
output:
  word_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "~/Desktop/R Working Directory")
```

```{r}
#install.packages("rtweet")
library(rtweet)
library(dplyr)
library(tidyr)
library(tidytext)

library(rjson)
library(jsonlite)

library(tidyverse)
library(lubridate)
library(zoo)

library(rtweet)
library(dplyr)
library(tidyverse)
#install.packages("twitteR")
library(twitteR)

options(stringsAsFactors = FALSE)
```

```{r}
app_name = 'CSUFSentimentAnalysis'
consumer_key = '4FotHBNuYzgVW9eRjX7VT1gQN'
consumer_secret = 'r8veJvJIUGERrZNOso5V8ivhRADD4niJkev4JyZmAtHu1ybTPD'
access_token = '1260639569629700101-6HuoMzITOpjKvL8TTiLaPLwVhmiSzs'
access_secret = 'OrCT1hOFWHNn8CU76X7hMrA1fHk3TvcBrBH9XoNDS5Wa2'


create_token(app=app_name,
             consumer_key = consumer_key,
             consumer_secret = consumer_secret,
             access_token = access_token,
             access_secret = access_secret)
```

```{r}
tweets.covid19 <- search_tweets("#covid19", n=100, lang = "en")
tweets.covid19
tweets.coronavirus <- search_tweets("#coronavirus", n=100, lang = "en")
```

```{r}
tweets.covid19 = tweets.covid19 %>% select(screen_name, text, created_at)
tweets.covid19
tweets.coronavirus = tweets.coronavirus %>% select(screen_name, text, created_at)

#head(tweets.USA$text)
tweets.covid19$stripped_text1 <- gsub("http\\S+","",tweets.covid19$text)

tweets.covid19_stem <- tweets.covid19 %>%
  select(stripped_text1) %>%
  unnest_tokens(word, stripped_text1)
head(tweets.covid19_stem)
#remove stop words
cleaned_tweets.covid19 <- tweets.covid19_stem %>%
  anti_join(stop_words)
head(cleaned_tweets.covid19)
head(tweets.covid19$text)

tweets.coronavirus$stripped_text2 <- gsub("https\\S+","",tweets.coronavirus$text)

tweets.coronavirus_stem <- tweets.coronavirus %>%
  select(stripped_text2) %>%
  unnest_tokens(word, stripped_text2)

head(tweets.coronavirus_stem)
#remove stop words
cleaned_tweets.coronavirus <- tweets.coronavirus_stem %>%
  anti_join(stop_words)
head(cleaned_tweets.coronavirus)
```

```{r}
#top 10 words in #covid19 tweets
cleaned_tweets.covid19 %>%
  count(word, sort=TRUE)%>%
  top_n(10) %>%
  mutate(word = reorder(word,n))%>%
  ggplot(aes(x=word,y=n))+
  geom_col()+
  xlab(NULL)+
  coord_flip()+
  theme_classic()+
  labs(x="count",y="unique words", title = "unique word counts from #covid19 tweets")

#top 10 words in #covid19 tweets
cleaned_tweets.coronavirus %>%
  count(word, sort=TRUE)%>%
  top_n(10) %>%
  mutate(word = reorder(word,n))%>%
  ggplot(aes(x=word,y=n))+
  geom_col()+
  xlab(NULL)+
  coord_flip()+
  theme_classic()+
  labs(x="count",y="unique words", title = "unique word counts from #coronavirus tweets")
```
```{r}
library(tidytext)
library(textdata)
get_sentiments("bing") %>%
  filter(sentiment=="positive")
get_sentiments("bing") %>%
  filter(sentiment=="negative")
get_sentiments("afinn") %>%
  filter(value=="3")
get_sentiments("afinn") %>%
  filter(value=="-3")
```
```{r}
#bing sentiment analysis
bing_covid19 = cleaned_tweets.covid19 %>%
  inner_join(get_sentiments("bing"))%>%
  count(word, sentiment, sort=TRUE)%>%
  ungroup()
bing_covid19 %>%
  group_by(sentiment)%>%
  top_n(10)%>%
  ungroup()%>%
  mutate(word = reorder(word,n))%>%
  ggplot(aes(word,n,fill=sentiment))+
  geom_col(show.legend = FALSE)+
  facet_wrap(~sentiment, scales = "free_y")+
  labs(title = "tweets containing '#covid19'",
       y = "contribution to sentiment",
       x = NULL)+
  coord_flip()+
  theme_bw()
```
```{r}
sentiment_bing = function(twt) {
  #step 1: perform basic text cleaning (on the tweet) as seen earlier
  twt_tbl = tibble(text = twt) %>%
    mutate(
      #remove http elements
      stripped_text = gsub("http\\S+","",text)
    )%>%
    unnest_tokens(word,stripped_text)%>%
    anti_join(stop_words)%>%
    inner_join(get_sentiments("bing"))%>%
    count(word,sentiment,sort=TRUE)%>%
    ungroup()%>%
    #create score column that assigns a -1 to all negative words, and a 1 to positive words
    mutate(
      score = case_when(
        sentiment =='negative'~n*(-1),
        sentiment =='positive'~n*1)
    )
  #calculate total score
  sent.score = case_when(
    nrow(twt_tbl)==0~0, #if there are no words, score is 0
    nrow(twt_tbl)>0~sum(twt_tbl$score) #otherwise, sum positive and negatives
  )
  zero.type = case_when(
    nrow(twt_tbl)==0~"Type 1", #type 1: no words at all, zero = no
    nrow(twt_tbl)>0~"Type 2" #type 2: zero means sum of words = 0
  )
  list(score = sent.score, type = zero.type, twt_tbl = twt_tbl)
}
```

```{r}
tweets.covid19_sent = lapply(tweets.covid19$text,function(x){sentiment_bing(x)})
tweets.coronavirus_sent = lapply(tweets.coronavirus$text,function(x){sentiment_bing(x)})

pandemic_sentiment = bind_rows(
  tibble(
    pandemic = '#covid19',
    score = unlist(map(tweets.covid19_sent,'score')),
    type = unlist(map(tweets.covid19_sent,'type'))
  ),
  tibble(
    pandemic = '#coronavirus',
    score = unlist(map(tweets.coronavirus_sent,'score')),
    type = unlist(map(tweets.coronavirus_sent,'type'))
  )
)
ggplot(pandemic_sentiment,aes(x=score,fill=pandemic))+
  geom_histogram(bins = 15, alpha = 0.6)+
  facet_grid(~pandemic)+
  theme_bw()
```









